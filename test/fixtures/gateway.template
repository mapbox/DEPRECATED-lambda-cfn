{"Parameters":{"token":{"Type":"String","Description":"token"},"CodeS3Bucket":{"Type":"String","Description":"lambda function S3 bucket location"},"CodeS3Prefix":{"Type":"String","Description":"lambda function S3 prefix location"},"GitSha":{"Type":"String","Description":"lambda function S3 prefix location"},"AlarmEmail":{"Type":"String","Description":"Service alarm notifications will send to this email address"}},"Resources":{"gatewayTestRuleAlarmErrors":{"Type":"AWS::CloudWatch::Alarm","Properties":{"EvaluationPeriods":"5","Statistic":"Sum","Threshold":"0","AlarmDescription":"https://github.com/mapbox/lambda-cfn/blob/master/alarms.md#Errors","Period":"60","AlarmActions":{"Ref":"LambdaCfnAlarmSNSTopic"},"Namespace":"AWS/Lambda","Dimensions":[{"Name":"FunctionName","Value":{"Ref":"gatewayTestRule"}}],"ComparisonOperator":"GreaterThanThreshold","MetricName":"Errors"}},"gatewayTestRuleAlarmNoInvocations":{"Type":"AWS::CloudWatch::Alarm","Properties":{"EvaluationPeriods":"5","Statistic":"Sum","Threshold":"0","AlarmDescription":"https://github.com/mapbox/lambda-cfn/blob/master/alarms.md#NoInvocations","Period":"60","AlarmActions":{"Ref":"LambdaCfnAlarmSNSTopic"},"Namespace":"AWS/Lambda","Dimensions":[{"Name":"FunctionName","Value":{"Ref":"gatewayTestRule"}}],"ComparisonOperator":"LessThanThreshold","MetricName":"Invocations"}},"gatewayTestRule":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Ref":"CodeS3Bucket"},"S3Key":{"Fn::Join":["",[{"Ref":"CodeS3Prefix"},{"Ref":"GitSha"},".zip"]]}},"Role":{"Fn::GetAtt":["LambdaCfnRole","Arn"]},"Description":{"Ref":"AWS::StackName"},"Environment":{"Variables":{"StackName":{"Ref":"AWS::StackName"},"Region":{"Ref":"AWS::Region"},"AccountId":{"Ref":"AWS::AccountId"},"StackId":{"Ref":"AWS::StackId"},"token":{"Ref":"token"},"CodeS3Bucket":{"Ref":"CodeS3Bucket"},"CodeS3Prefix":{"Ref":"CodeS3Prefix"},"GitSha":{"Ref":"GitSha"},"AlarmEmail":{"Ref":"AlarmEmail"}}},"Handler":"function","Timeout":60,"MemorySize":128,"Runtime":"nodejs4.3"}},"LambdaCfnRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Sid":"","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"},"Action":"sts:AssumeRole"},{"Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"},"Action":"sts:AssumeRole"}]},"Path":"/","Policies":[{"PolicyName":"basic","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["logs:FilterLogEvents","logs:GetLogEvents"],"Resource":{"Fn::Join":["",["arn:aws:logs:*:",{"Ref":"AWS::AccountId"},":*"]]}},{"Effect":"Allow","Action":["sns:Publish"],"Resource":{"Ref":"LambdaCfnAlarmSNSTopic"}},{"Effect":"Allow","Action":["iam:SimulateCustomPolicy"],"Resource":"*"}]}}]}},"gatewayTestRuleSNSPermission":{"Type":"AWS::Lambda::Permission","Properties":{"FunctionName":{"Fn::GetAtt":["gatewayTestRule","Arn"]},"Action":"lambda:InvokeFunction","Principal":"sns.amazonaws.com","SourceArn":{"Ref":"gatewayTestRuleSNSTopic"}}},"gatewayTestRuleSNSUser":{"Type":"AWS::IAM::User","Properties":{"Policies":[{"PolicyName":"gatewayTestRuleSNSTopicPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Resource":{"Ref":"gatewayTestRuleSNSTopic"},"Action":["sns:ListTopics","sns:Publish"],"Effect":"Allow"},{"Resource":{"Fn::Join":["",["arn:aws:sns:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":*"]]},"Action":["sns:ListTopics"],"Effect":"Allow"}]}}]}},"gatewayTestRuleSNSTopic":{"Type":"AWS::SNS::Topic","Properties":{"DisplayName":{"Fn::Join":["-",[{"Ref":"AWS::StackName"},"gatewayTestRule"]]},"TopicName":{"Fn::Join":["-",[{"Ref":"AWS::StackName"},"gatewayTestRule"]]},"Subscription":[{"Endpoint":{"Fn::GetAtt":["gatewayTestRule","Arn"]},"Protocol":"lambda"}]}},"gatewayTestRuleSNSUserAccessKey":{"Type":"AWS::IAM::AccessKey","Properties":{"UserName":{"Ref":"gatewayTestRuleSNSUser"}}},"LambdaCfnAlarmSNSTopic":{"Type":"AWS::SNS::Topic","Properties":{"TopicName":{"Ref":"AWS::StackName"},"Subscription":[{"Endpoint":{"Ref":"AlarmEmail"},"Protocol":"email"}]}}},"Outputs":{"gatewayTestRuleSNSTopic":{"Value":{"Ref":"gatewayTestRuleSNSTopic"}},"gatewayTestRuleSNSUserAccessKey":{"Value":{"Ref":"gatewayTestRuleSNSUserAccessKey"}},"gatewayTestRuleSNSUserSecretAccessKey":{"Value":{"Fn::GetAtt":["gatewayTestRuleSNSUserAccessKey","SecretAccessKey"]}}},"AWSTemplateFormatVersion":"2010-09-09","Description":"gatewayTestRule lambda-cfn function"}
